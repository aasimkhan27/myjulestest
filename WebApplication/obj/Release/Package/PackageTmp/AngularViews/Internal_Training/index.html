<div ng-controller="Create_Invoice_Controller">
    <form name="INVOICE_FORM" id="INVOICE_FORM" novalidate>
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">
                    {{(BRANCH_LOGIN_LIST | filter:{BRANCH_ID:Invoice_Search.BRANCH_ID})[0].BRANCH_NAME}}
                    <i ng-show="BRANCH_LOGIN_LIST.length>1" class="far fa-edit cursor-pointer text-blue" data-toggle="modal" data-target="#select_branch"></i>
                </h5>
                <div class="card-tools ml-auto">
                    <ul class="nav nav-pills">
                        <li class="nav-item"><button type="button" ng-click="INS_UPD_INVOICES()" class="btn btn-wenodo mr-2">Submit</button></li>
                        <li class="nav-item"><button type="button" ng-click="RESET_INVOICE()" class="btn btn-transparent-wenodo" data-toggle="tooltip" data-html="true" data-original-title="Reset"><i class="fad fa-undo-alt"></i></button></li>
                    </ul>
                </div>
            </div>
            <div class="card-body">
                <div class="row mt-3">
                    <div class="col-md-4">
                        <div class="form-group" id="AddCustomScroll_SHD">
                            <label>Contact <span class="text-danger">*</span></label>
                            <input type="text" name="SUPPLIER_NAME_BOX"
                                   ng-model="Invoice_Search.SUPPLIER_NAME"
                                   ng-change="SetValues(Supplier,$index)"
                                   uib-typeahead="Supplier.SUPPLIER_NAME for Supplier in INVOICE_SUPPLIER_LIST | filter:$viewValue"
                                   typeahead-loading="loading" typeahead-no-results="noResults"
                                   class="form-control form-control-sm" autocomplete="off"
                                   required
                                   placeholder="Type to select Supplier Name..."
                                   ng-class="{'error':INVOICE_FORM.submitted && INVOICE_FORM.SUPPLIER_NAME_BOX.$error.required}" />
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label>Date <span class="text-danger">*</span></label>
                            <input type="text" class="form-control dateinput"
                                   name="DATE"
                                   placeholder="Select date"
                                   ng-model="Invoice_Search.INVOICE_DATE"
                                   ng-value="Invoice_Search.INVOICE_DATE | date"
                                   required
                                   readonly
                                   ng-class="{'error':INVOICE_FORM.submitted && INVOICE_FORM.DATE.$error.required}" />
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label>Due Date <span class="text-danger">*</span></label>
                            <input type="text" class="form-control dateinput"
                                   name="DUE_DATE"
                                   placeholder="Select due date"
                                   ng-model="Invoice_Search.DUE_DATE"
                                   ng-value="Invoice_Search.DUE_DATE | date"
                                   required
                                   readonly
                                   ng-class="{'error':INVOICE_FORM.submitted && INVOICE_FORM.DUE_DATE.$error.required}" />
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label>Invoice Number <span class="text-danger">*</span></label>
                            <input type="text" class="form-control"
                                   name="INVOICE_NUMBER"
                                   required
                                   placeholder="Enter Invoice Number"
                                   ng-model="Invoice_Search.INVOICE_NUMBER"
                                   ng-class="{'error':INVOICE_FORM.submitted && INVOICE_FORM.INVOICE_NUMBER.$error.required}" />


                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label>Reference</label>
                            <input type="text" class="form-control"
                                   name="REFERENCE"
                                   placeholder="Enter reference"
                                   ng-model="Invoice_Search.REFERENCE"
                                   ng-class="{'error':INVOICE_FORM.submitted && INVOICE_FORM.REFERENCE.$error.required}" />
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label>Project</label>
                            <select class="custom-select mw-150"
                                    name="PROJECT_MASTER_ID"
                                    ng-model="Invoice_Search.PROJECT_MASTER_ID"
                                    ng-options="T.PROJECT_MASTER_ID as T.PROJECT_NAME for T in INVOICE_PROJECT_MASTER_LIST">
                                <option value="">-Select Project-</option>
                            </select>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label>Themes</label>
                            <select class="custom-select mw-150"
                                    name="XERO_BRANDING_THEMES_ID"
                                    ng-model="Invoice_Search.XERO_BRANDING_THEME_ID"
                                    ng-options="T.XERO_BRANDING_THEME_ID as T.NAME for T in INVOICE_XERO_BRANDING_THEMES_LIST"
                                    ng-class="{'error':INVOICE_FORM.submitted && INVOICE_FORM.XERO_BRANDING_THEMES_ID.$error.required}">
                                <option value="">-Select Theme-</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mt-3">
                        <h5 class="card-title mt-4">Line Items</h5>
                        <div class="row">
                            <div class="col-auto font-11 mt-2 ml-auto">
                                <span ng-show="Invoice_Search.BASE_CURRENCY_ID!=Invoice_Search.INVOICE_CURRENCY_ID">
                                    <!--Currency rate for {{REQ_Search.CURRENT_DATE | date}} provided by openexchangerates.org, will be applied after submission.-->
                                </span>
                            </div>
                            <div class="col-auto">
                                <label class=""> </label>
                                <div class="form-inline mb-2" ng-show="Invoice_Search.BASE_CURRENCY_ID!=Invoice_Search.INVOICE_CURRENCY_ID">
                                    <label class="mr-2">1  &nbsp;{{Invoice_Search.BASE_CURRENCY_NAME }} = </label>
                                    <input type="text"
                                           class="form-control"
                                           name="CURRENCY_CONVER"
                                           placeholder="Enter value"
                                           maxlength="10"
                                           ng-required="Invoice_Search.BASE_CURRENCY_ID!=Invoice_Search.INVOICE_CURRENCY_ID"
                                           ng-model="Invoice_Search.BASE_TO_INVOICE_CONVERSION_RATE"
                                           ng-class="{'error':INVOICE_FORM.submitted && INVOICE_FORM.CURRENCY_CONVER.$error.required}" />
                                    <!--<label class="mr-2">  &nbsp;{{REQ_Search.INVOICE_CURRENCY_NAME }} </label>-->
                                </div>
                            </div>
                            <div class="col-auto">
                                <div class=" mb-2">
                                    <label class="">Invoice Currency </label>
                                    <select class="custom-select mw-150"
                                            name="CURRENCY_ID"
                                            ng-model="Invoice_Search.INVOICE_CURRENCY_ID"
                                            ng-options="T.CURRENCY_ID as T.DISPLAY_TEXT +'-' + T.CURRENCY_NAME for T in INVOICE_CURRENCY_LIST"
                                            ng-class="{'error':INVOICE_FORM.submitted && INVOICE_FORM.CURRENCY_ID.$error.required}"></select>
                                </div>
                            </div>

                            <div class="col-auto">
                                <div class=" mb-2">
                                    <label class="">Amounts are </label>
                                    <select class="custom-select mw-150"
                                            name="TAX_TYPE"
                                            ng-model="Invoice_Search.TAX_TYPE"
                                            ng-options="T.ID as T.NAME for T in INVOICE_TAX_TYPE"
                                            ng-class="{'error':INVOICE_FORM.submitted && INVOICE_FORM.TAX_TYPE.$error.required}"></select>
                                </div>
                            </div>


                        </div>
                        <div class="table-responsive" style="overflow-x:visible">
                            <table class="table table-head-fixed table-hover table-form table-bordered">
                                <thead class="bg-wenodo-border">
                                    <tr>
                                        <th width="15%">Item <span class="text-danger">*</span></th>
                                        <th width="20%">Description <span class="text-danger">*</span></th>
                                        <th>Quantity <span class="text-danger">*</span></th>
                                        <th>Unit Price <span class="text-danger">*</span></th>
                                        <th>UOM </th>
                                        <th width="5%">Disc %</th>
                                        <th>GL Account <span class="text-danger">*</span></th>
                                        <th>Tax Rate <span class="text-danger">*</span></th>
                                        <th class="text-right">Tax</th>
                                        <th class="text-right">Amount</th>
                                        <th ng-repeat="TrackingCat in INVOICE_XERO_TRACKING_CATEGORIES track by $index">{{TrackingCat.FIELD_NAME}}</th>
                                        <th width="3%" class="text-center"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr ng-repeat="PRL in INVOICE_ITEM_LIST" ng-init="InitiateEditItemList(PRL,1);">
                                        <td>
                                            <span ng-show="false">
                                                {{PRL.LINE_NO=($index+1)}}
                                            </span>
                                            <input type="text"
                                                   name="ITEM_NAME{{$index}}"
                                                   class="hidden-input"
                                                   required
                                                   maxlength="200"
                                                   placeholder="Enter item name"
                                                   ng-model="PRL.ITEM_NAME"
                                                   ng-class="{'error':INVOICE_FORM.submitted && INVOICE_FORM.ITEM_NAME{{$index}}.$error.required}" />
                                        </td>
                                        <td>
                                            <textarea class="hidden-input scroll"
                                                      name="DESCRIPTION{{$index}}"
                                                      required
                                                      id="text"
                                                      maxlength="2000"
                                                      onInput="this.parentNode.dataset.replicatedValue = this.value"
                                                      placeholder="Enter description"
                                                      ng-model="PRL.DESCRIPTION"
                                                      ng-class="{'error':INVOICE_FORM.submitted && INVOICE_FORM.DESCRIPTION{{$index}}.$error.required}"></textarea>
                                        </td>
                                        <td>
                                            <input type="text" class="hidden-input"
                                                   name="QUANTITY{{$index}}"
                                                   only-digits
                                                   placeholder="Enter QTY."
                                                   maxlength="13"
                                                   required
                                                   ng-model="PRL.QUANTITY"
                                                   ng-class="{'error':INVOICE_FORM.submitted && INVOICE_FORM.QUANTITY{{$index}}.$error.required}" />
                                        </td>
                                        <td>
                                            <input type="text" class="hidden-input"
                                                   only-digits
                                                   required
                                                   maxlength="13"
                                                   placeholder="Enter unit price"
                                                   name="UNIT_PRICE{{$index}}"
                                                   ng-class="{'error':INVOICE_FORM.submitted && INVOICE_FORM.UNIT_PRICE{{$index}}.$error.required}"
                                                   ng-model="PRL.UNIT_PRICE" />
                                        </td>
                                        <td>
                                            <input type="text" class="hidden-input"
                                                   name="UOM_NAME{{$index}}"
                                                   maxlength="30"
                                                   placeholder="Enter UOM"
                                                   ng-model="PRL.UOM_NAME"
                                                   ng-class="{'error':INVOICE_FORM.submitted && INVOICE_FORM.UOM_NAME{{$index}}.$error.required}" />
                                        </td>
                                        <td>
                                            <input type="text" class="hidden-input"
                                                   name="DISCOUNT_PERCENT{{$index}}"
                                                   only-digits
                                                   maxlength="4"
                                                   placeholder="Enter discount"
                                                   ng-class="{'error':INVOICE_FORM.submitted && INVOICE_FORM.DISCOUNT_PERCENT{{$index}}.$error.required}"
                                                   ng-model="PRL.DISCOUNT_PERCENT" />
                                        </td>

                                        <td>
                                            <div class="AddCustomScroll_Account">
                                                <input type="text" name="ACCOUNT_NAME_BOX"
                                                       ng-model="PRL.ACCOUNT_NAME"
                                                       ng-change="SetAccountValues(Acct,$index)"
                                                       uib-typeahead="Acct.CODE + ' - ' + Acct.NAME  for Acct in INVOICE_XERO_ACCOUNT_CODES | filter:$viewValue"
                                                       typeahead-loading="loading" typeahead-no-results="noResults"
                                                       class="hidden-input" autocomplete="off"
                                                       required
                                                       placeholder="Type to select account name..."
                                                       ng-class="{'error':INVOICE_FORM.submitted && INVOICE_FORM.ACCOUNT_NAME_BOX.$error.required || INVOICE_FORM.submitted && PRL.IS_ACCOUNT_VALID}" />
                                            </div>
                                            <small ng-show="PRL.IS_ACCOUNT_VALID">Invalid Account Name</small>
                                        </td>
                                        <td>
                                            <select class="hidden-input"
                                                    name="TAX_TYPE{{$index}}"
                                                    ng-model="PRL.TAX_ID"
                                                    ng-options="XT as XT.NAME +' ('+ XT.RATE +')'  for XT in INVOICE_XERO_TAXES"
                                                    required
                                                    ng-change="TAXPERCENTAGE_CHANGE(PRL.TAX_ID,PRL);"
                                                    ng-class="{'error':INVOICE_FORM.submitted && INVOICE_FORM.TAX_TYPE{{$index}}.$error.required}">
                                                <option value="">- Select Tax -</option>
                                            </select>
                                        </td>
                                        <td class="text-right text-nowrap pr-2">
                                            {{PRL.TAX_AMOUNT=Invoice_Search.TAX_TYPE==3?0: (Invoice_Search.TAX_TYPE==2?((((PRL.UNIT_PRICE*PRL.QUANTITY) / (1 + (PRL.TAX_ID.RATE/100)))-(((PRL.UNIT_PRICE*PRL.QUANTITY) / (1 + (PRL.TAX_ID.RATE/100)))*(PRL.DISCOUNT_PERCENT/100))) * (PRL.TAX_ID.RATE/100)):(((PRL.UNIT_PRICE*PRL.QUANTITY)-((PRL.UNIT_PRICE*PRL.QUANTITY)*(PRL.DISCOUNT_PERCENT/100))) * (PRL.TAX_ID.RATE/100))) | number:2}}
                                        </td>
                                        <td class="text-right text-nowrap pr-2">
                                            {{PRL.AMOUNT= ((PRL.QUANTITY * PRL.UNIT_PRICE) - (PRL.QUANTITY*1 * PRL.UNIT_PRICE*1 * (PRL.DISCOUNT_PERCENT)/100)) | number:2}}
                                        </td>

                                        <td ng-repeat="TrackingCat in PRL.INVOICE_XERO_TRACKING_CATEGORIES track by $index" ng-init="InitiateEditXeroTrackingCategories(TrackingCat, $index,PRL,1);">
                                            <select class="hidden-input"
                                                    ng-model="TrackingCat.SELECTED_CATEGORY_OPTION"
                                                    ng-options="XT as XT.OPTION_NAME for XT in INVOICE_XERO_TRACKING_CATEGORIES_OPTIONS | filter:{APPROVAL_CHAIN_CUSTOM_FIELDS_MASTER_ID:TrackingCat.APPROVAL_CHAIN_CUSTOM_FIELDS_MASTER_ID}">
                                                <option value="">- Please Select -</option>
                                            </select>
                                        </td>
                                        <td class="text-center">
                                            <i ng-show="!$first" class="far fa-times-circle cursor-pointer text-danger"
                                               ng-click="REMOVE_LINE_ITEM_INVOICE($index,PRL)"
                                               data-toggle="tooltip" data-html="true" data-original-title="Remove">
                                            </i>
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="{{INVOICE_XERO_TRACKING_CATEGORIES.length+12}}"
                                            ng-click="ADD_MORE_ITEM_INVOICE()" class="text-center cursor-pointer">
                                            <a class="text-blue cursor-pointer text-sm"><i class="far fa-plus"></i>{{ADD_MORE_ITEM_NAME}}</a>
                                        </td>
                                    </tr>
                                    <tr class="text-bold table-footer-fixed">
                                        <td colspan="9" class="text-right font-13">Sub Total</td>
                                        <td class="text-right text-nowrap pr-2 font-13">{{Invoice_Search.NET_AMOUNT=(INVOICE_ITEM_LIST | total: 'AMOUNT') | number:2}}</td>
                                        <td colspan="{{INVOICE_XERO_TRACKING_CATEGORIES.length+2}}"></td>
                                    </tr>
                                    <tr class="text-bold table-footer-fixed" ng-repeat="TAX in INVOICE_ITEM_LIST | unique:'TAX_ID'" ng-if="TAX.TAX_ID!=null">
                                        <td colspan="9" class="text-right font-13">{{TAX.TAX_ID.NAME}} ({{TAX.TAX_ID.RATE +'%'}})</td>
                                        <td class="text-right text-nowrap pr-2 font-13">{{ INVOICE_ITEM_LIST | filter:{TAX_ID:TAX.TAX_ID} | total:'TAX_AMOUNT' | number:2}}<!--Taxamount=((UnitPrice*Qty)/(1 + Tax%))*tax%--></td>
                                        <td colspan="{{INVOICE_XERO_TRACKING_CATEGORIES.length+2}}"></td>
                                    </tr>
                                    <tr class="text-bold table-footer-fixed">
                                        <td colspan="9" class="text-right font-13">Total</td>
                                        <td class="text-right text-nowrap pr-2 font-14">
                                            <span ng-show="false">
                                                {{Invoice_Search.TAX_AMOUNT= (INVOICE_ITEM_LIST | total:'TAX_AMOUNT') | number:2}}
                                            </span>

                                            <span ng-if="Invoice_Search.TAX_TYPE==1">
                                                {{Invoice_Search.TOTAL_AMOUNT=((INVOICE_ITEM_LIST | total: 'AMOUNT') + (INVOICE_ITEM_LIST | total: 'TAX_AMOUNT')) | number:2}}
                                            </span>
                                            <span ng-if="Invoice_Search.TAX_TYPE==2">
                                                {{Invoice_Search.TOTAL_AMOUNT=(INVOICE_ITEM_LIST | total: 'AMOUNT')  | number:2}}
                                            </span>
                                            <span ng-if="Invoice_Search.TAX_TYPE==3">
                                                {{Invoice_Search.TOTAL_AMOUNT=(INVOICE_ITEM_LIST | total: 'AMOUNT') | number:2}}
                                            </span>
                                            {{(INVOICE_CURRENCY_LIST | filter :{CURRENCY_ID:Invoice_Search.INVOICE_CURRENCY_ID})[0].CURRENCY_CODE }}
                                        </td>
                                        <td colspan="{{INVOICE_XERO_TRACKING_CATEGORIES.length+2}}"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div class="col-md-12 border-bottom"></div>
                    </div>
                    <div class="col-md-6 mt-3 ">
                        <div class="upload-files-container">
                            <div class="drag-file-area mx-100 w-60">
                                <label class="label">
                                    <span class="browse-files">
                                        <input type="file" class="default-file-input" id="INVOICE1"
                                               ng-model="Invoice_Search.UploadedFiles"
                                               ng-files="getTheFilesToUpload($files,'INVOICE',5,Invoice_Search,33,'1','INVOICE',10,'P2P_Upload_Path','P2P')" />
                                        <span class="browse-files-text mt-3"><i class="far fa-upload"></i> Add an Attachment</span>
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mt-3">
                        <div class="file-block" ng-repeat="file in Invoice_Search.UploadedFiles">
                            <div class="file-info">
                                <i class="far fa-file-alt file-icon"></i>
                                <a href="/P2PFiles/{{file.FILE_PATH}}{{file.SERVER_FILE_NAME}}"> <span class="file-name text-nowrap">{{file.ORIGINAL_FILE_NAME}} </span></a>
                            </div>
                            <span class="remove-file-icon" ng-click="REMOVE_FILTE($index)"><i class="fa fa-times"></i></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>